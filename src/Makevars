CXX_STD = CXX17

# Base include paths and defines
GGML_CPPFLAGS = -I. -Iggml-cpu -Iggml-cpu/arch/x86 \
  -DGGML_VERSION='"0.9.5"' -DGGML_COMMIT='"ggmlR"' \
  -DGGML_USE_CPU -D_GNU_SOURCE

# Vulkan flags (set by configure --with-vulkan)
VULKAN_CPPFLAGS =  -DGGML_USE_VULKAN -Iggml-vulkan -Iggml-vulkan/generated
VULKAN_LIBS = -lvulkan 

# --- OpenMP configuration ---
#
# CRAN R CMD check enforces strict pairing of SHLIB_OPENMP_*FLAGS macros:
#   - PKG_CFLAGS must use SHLIB_OPENMP_CFLAGS
#   - PKG_CXXFLAGS must use SHLIB_OPENMP_CXXFLAGS
#   - PKG_LIBS must use the macro matching the linker language
#   - Multiple SHLIB_OPENMP_* macros in PKG_LIBS are not allowed
#   - Mismatched macros (e.g. CXXFLAGS in CFLAGS) trigger NOTE
#
# For mixed C/C++ packages this creates an unsolvable conflict:
# linking is by C++, so PKG_LIBS needs CXXFLAGS, but C code also needs
# CFLAGS for compilation, which then has no matching pair in PKG_LIBS.
#
# Solution: resolve OpenMP flags at configure time from R's Makeconf
# (see RcppArmadillo for the same approach). The configure script reads
# SHLIB_OPENMP_CFLAGS and SHLIB_OPENMP_CXXFLAGS and substitutes them
# here as literal values. R CMD check does not see the SHLIB_OPENMP_*
# macro names, so the NOTE disappears.
#
# On macOS (Apple clang) both values are empty -> OpenMP disabled,
# code falls back to pthreads (#ifndef GGML_USE_OPENMP in ggml-cpu-backend.c).
#
OPENMP_CPPFLAGS = -DGGML_USE_OPENMP
OPENMP_CFLAGS = -fopenmp
OPENMP_CXXFLAGS = -fopenmp

# Force include R compatibility header for CRAN compliance
# This redirects stdout/stderr/abort to R-safe alternatives
# r_ggml_io.c is compiled separately without this header (see rule below)
PKG_CPPFLAGS = $(GGML_CPPFLAGS) $(OPENMP_CPPFLAGS) $(VULKAN_CPPFLAGS) -DGGML_R_PACKAGE -include r_ggml_compat.h

PKG_CFLAGS = $(OPENMP_CFLAGS)
PKG_CXXFLAGS = $(OPENMP_CXXFLAGS)
PKG_LIBS = $(OPENMP_CXXFLAGS) $(VULKAN_LIBS) -lpthread -lm

# GGML library objects (for static library export)
GGML_OBJECTS = \
  r_ggml_io.o \
  ggml.o ggml-alloc.o ggml-quants.o ggml-opt.o gguf.o \
  ggml-backend.o ggml-backend-reg.o ggml-threading.o \
  ggml-cpu/traits.o \
  ggml-cpu/ggml-cpu-backend.o ggml-cpu/ggml-cpu.o \
  ggml-cpu/ops.o ggml-cpu/vec.o \
  ggml-cpu/binary-ops.o ggml-cpu/unary-ops.o ggml-cpu/repack.o \
  ggml-cpu/quants.o ggml-cpu/hbm.o \
  ggml-cpu/arch/x86/cpu-feats.o ggml-cpu/arch/x86/quants.o ggml-cpu/arch/x86/repack.o

# R interface objects
R_INTERFACE_OBJECTS = \
  r_interface.o r_interface_graph.o r_interface_vulkan.o r_interface_scheduler.o r_interface_opt.o r_interface_backend.o r_interface_quants.o

# Vulkan objects (set by configure --with-vulkan)
VULKAN_OBJECTS = ggml-vulkan/ggml-vulkan.o ggml-vulkan/generated/abs.comp.o ggml-vulkan/generated/acc.comp.o ggml-vulkan/generated/add.comp.o ggml-vulkan/generated/add1.comp.o ggml-vulkan/generated/add_id.comp.o ggml-vulkan/generated/arange.comp.o ggml-vulkan/generated/argmax.comp.o ggml-vulkan/generated/argsort.comp.o ggml-vulkan/generated/argsort_large.comp.o ggml-vulkan/generated/ceil.comp.o ggml-vulkan/generated/clamp.comp.o ggml-vulkan/generated/concat.comp.o ggml-vulkan/generated/contig_copy.comp.o ggml-vulkan/generated/conv2d_dw.comp.o ggml-vulkan/generated/conv2d_mm.comp.o ggml-vulkan/generated/conv_transpose_1d.comp.o ggml-vulkan/generated/copy.comp.o ggml-vulkan/generated/copy_from_quant.comp.o ggml-vulkan/generated/copy_to_quant.comp.o ggml-vulkan/generated/copy_transpose.comp.o ggml-vulkan/generated/cos.comp.o ggml-vulkan/generated/count_equal.comp.o ggml-vulkan/generated/count_experts.comp.o ggml-vulkan/generated/cumsum.comp.o ggml-vulkan/generated/dequant_f32.comp.o ggml-vulkan/generated/dequant_iq1_m.comp.o ggml-vulkan/generated/dequant_iq1_s.comp.o ggml-vulkan/generated/dequant_iq2_s.comp.o ggml-vulkan/generated/dequant_iq2_xs.comp.o ggml-vulkan/generated/dequant_iq2_xxs.comp.o ggml-vulkan/generated/dequant_iq3_s.comp.o ggml-vulkan/generated/dequant_iq3_xxs.comp.o ggml-vulkan/generated/dequant_iq4_nl.comp.o ggml-vulkan/generated/dequant_iq4_xs.comp.o ggml-vulkan/generated/dequant_mxfp4.comp.o ggml-vulkan/generated/dequant_q2_k.comp.o ggml-vulkan/generated/dequant_q3_k.comp.o ggml-vulkan/generated/dequant_q4_0.comp.o ggml-vulkan/generated/dequant_q4_1.comp.o ggml-vulkan/generated/dequant_q4_k.comp.o ggml-vulkan/generated/dequant_q5_0.comp.o ggml-vulkan/generated/dequant_q5_1.comp.o ggml-vulkan/generated/dequant_q5_k.comp.o ggml-vulkan/generated/dequant_q6_k.comp.o ggml-vulkan/generated/dequant_q8_0.comp.o ggml-vulkan/generated/diag.comp.o ggml-vulkan/generated/diag_mask_inf.comp.o ggml-vulkan/generated/div.comp.o ggml-vulkan/generated/exp.comp.o ggml-vulkan/generated/fill.comp.o ggml-vulkan/generated/flash_attn.comp.o ggml-vulkan/generated/flash_attn_cm1.comp.o ggml-vulkan/generated/flash_attn_cm2.comp.o ggml-vulkan/generated/flash_attn_split_k_reduce.comp.o ggml-vulkan/generated/floor.comp.o ggml-vulkan/generated/geglu.comp.o ggml-vulkan/generated/geglu_erf.comp.o ggml-vulkan/generated/geglu_quick.comp.o ggml-vulkan/generated/gelu.comp.o ggml-vulkan/generated/gelu_erf.comp.o ggml-vulkan/generated/gelu_quick.comp.o ggml-vulkan/generated/get_rows.comp.o ggml-vulkan/generated/get_rows_quant.comp.o ggml-vulkan/generated/group_norm.comp.o ggml-vulkan/generated/hardsigmoid.comp.o ggml-vulkan/generated/hardswish.comp.o ggml-vulkan/generated/im2col.comp.o ggml-vulkan/generated/im2col_3d.comp.o ggml-vulkan/generated/l2_norm.comp.o ggml-vulkan/generated/leaky_relu.comp.o ggml-vulkan/generated/log.comp.o ggml-vulkan/generated/mul.comp.o ggml-vulkan/generated/mul_mat_split_k_reduce.comp.o ggml-vulkan/generated/mul_mat_vec.comp.o ggml-vulkan/generated/mul_mat_vec_iq1_m.comp.o ggml-vulkan/generated/mul_mat_vec_iq1_s.comp.o ggml-vulkan/generated/mul_mat_vec_iq2_s.comp.o ggml-vulkan/generated/mul_mat_vec_iq2_xs.comp.o ggml-vulkan/generated/mul_mat_vec_iq2_xxs.comp.o ggml-vulkan/generated/mul_mat_vec_iq3_s.comp.o ggml-vulkan/generated/mul_mat_vec_iq3_xxs.comp.o ggml-vulkan/generated/mul_mat_vec_nc.comp.o ggml-vulkan/generated/mul_mat_vec_p021.comp.o ggml-vulkan/generated/mul_mat_vec_q2_k.comp.o ggml-vulkan/generated/mul_mat_vec_q3_k.comp.o ggml-vulkan/generated/mul_mat_vec_q4_k.comp.o ggml-vulkan/generated/mul_mat_vec_q5_k.comp.o ggml-vulkan/generated/mul_mat_vec_q6_k.comp.o ggml-vulkan/generated/mul_mat_vecq.comp.o ggml-vulkan/generated/mul_mm.comp.o ggml-vulkan/generated/mul_mm_cm2.comp.o ggml-vulkan/generated/mul_mmq.comp.o ggml-vulkan/generated/multi_add.comp.o ggml-vulkan/generated/neg.comp.o ggml-vulkan/generated/norm.comp.o ggml-vulkan/generated/opt_step_adamw.comp.o ggml-vulkan/generated/opt_step_sgd.comp.o ggml-vulkan/generated/pad.comp.o ggml-vulkan/generated/pool2d.comp.o ggml-vulkan/generated/quantize_q8_1.comp.o ggml-vulkan/generated/reglu.comp.o ggml-vulkan/generated/relu.comp.o ggml-vulkan/generated/repeat.comp.o ggml-vulkan/generated/repeat_back.comp.o ggml-vulkan/generated/rms_norm.comp.o ggml-vulkan/generated/rms_norm_back.comp.o ggml-vulkan/generated/rms_norm_partials.comp.o ggml-vulkan/generated/roll.comp.o ggml-vulkan/generated/rope_multi.comp.o ggml-vulkan/generated/rope_neox.comp.o ggml-vulkan/generated/rope_norm.comp.o ggml-vulkan/generated/rope_vision.comp.o ggml-vulkan/generated/round.comp.o ggml-vulkan/generated/scale.comp.o ggml-vulkan/generated/sigmoid.comp.o ggml-vulkan/generated/silu.comp.o ggml-vulkan/generated/silu_back.comp.o ggml-vulkan/generated/sin.comp.o ggml-vulkan/generated/soft_max.comp.o ggml-vulkan/generated/soft_max_back.comp.o ggml-vulkan/generated/soft_max_large1.comp.o ggml-vulkan/generated/soft_max_large2.comp.o ggml-vulkan/generated/soft_max_large3.comp.o ggml-vulkan/generated/softplus.comp.o ggml-vulkan/generated/solve_tri.comp.o ggml-vulkan/generated/sqrt.comp.o ggml-vulkan/generated/square.comp.o ggml-vulkan/generated/ssm_conv.comp.o ggml-vulkan/generated/ssm_scan.comp.o ggml-vulkan/generated/step.comp.o ggml-vulkan/generated/sub.comp.o ggml-vulkan/generated/sum_rows.comp.o ggml-vulkan/generated/swiglu.comp.o ggml-vulkan/generated/swiglu_oai.comp.o ggml-vulkan/generated/tanh.comp.o ggml-vulkan/generated/timestep_embedding.comp.o ggml-vulkan/generated/topk_argsort.comp.o ggml-vulkan/generated/topk_moe.comp.o ggml-vulkan/generated/topk_nary_search.comp.o ggml-vulkan/generated/tri.comp.o ggml-vulkan/generated/trunc.comp.o ggml-vulkan/generated/upscale.comp.o ggml-vulkan/generated/wkv6.comp.o ggml-vulkan/generated/wkv7.comp.o ggml-vulkan/generated/xielu.comp.o
GGML_OBJECTS += $(VULKAN_OBJECTS)

# All objects for shared library
OBJECTS = $(R_INTERFACE_OBJECTS) $(GGML_OBJECTS)

# Static library for linking by other packages
STATICLIB = libggml.a

$(SHLIB): $(OBJECTS) staticlib

.PHONY: staticlib

staticlib: $(GGML_OBJECTS)
	$(AR) rcs $(STATICLIB) $(GGML_OBJECTS)
	cp $(STATICLIB) ../inst/lib/

# R interface files and r_ggml_io.c include R headers (R.h, Rinternals.h)
# which contain __attribute__((format(printf, ...))). Our macro
# '#define printf r_ggml_printf' would turn this into format(r_ggml_printf, ...)
# which GCC rejects as an unrecognized format type.
# R_GGML_IO_IMPL disables all macro redirections in r_ggml_compat.h.
# These files use only R API (Rprintf, Rf_error), not stdio printf/fprintf,
# so they don't need the redirections.
r_ggml_io.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
r_interface.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
r_interface_graph.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
r_interface_vulkan.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
r_interface_scheduler.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
r_interface_opt.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
r_interface_backend.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
r_interface_quants.o: PKG_CPPFLAGS += -DR_GGML_IO_IMPL
